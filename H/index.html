<!DOCTYPE html>
<html>
<head>
    <title>解锁成功 - 氢写真</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #f0f0f0; }
        #pdf-container { max-width: 100%; padding: 20px 0; }
        .page-wrapper { 
            margin: 10px auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: white;
        }
        .page-canvas { width: 100% !important; height: auto !important; }

        .wechat-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 9999;
            pointer-events: none;
            backdrop-filter: blur(28px);
            -webkit-backdrop-filter: blur(28px);
            background: rgba(255, 255, 255, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .tip-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            pointer-events: auto;
            max-width: 90%;
            text-align: center;
        }
        .tip-text {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #333;
        }
        .copy-btn {
            background: #07c160;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 25px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .copy-btn.copied { background: #1890ff; }
    </style>
</head>
<body>
    <div id="loading">正在加载文档...</div>
    <div id="pdf-container"></div>

    <script>
        // 微信提示层
        document.addEventListener('DOMContentLoaded', () => {
            if (/MicroMessenger/i.test(navigator.userAgent)) {
                const tip = document.createElement('div');
                tip.innerHTML = `
                    <div class="wechat-overlay">
                        <div class="tip-card">
                            <div class="tip-text">微信内看图体验受限，请复制链接到浏览器打开</div>
                            <button class="copy-btn" onclick="copyUrl(this)">点击复制链接</button>
                        </div>
                    </div>`;
                document.body.prepend(tip);
            }
        });

        // 复制功能
        function copyUrl(btn) {
            const url = window.location.href;
            if(btn.classList.contains('copying')) return;
            
            btn.classList.add('copying');
            const success = () => {
                btn.textContent = '已复制 ✓';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = '点击复制链接';
                    btn.classList.remove('copied', 'copying');
                }, 2000);
            };

            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(success).catch(fallback);
            } else {
                fallback();
            }

            function fallback() {
                const input = document.createElement('input');
                input.value = url;
                document.body.append(input);
                input.select();
                try {
                    document.execCommand('copy');
                    success();
                } catch {
                    prompt('请手动复制链接:', url);
                } finally {
                    input.remove();
                }
            }
        }

        // PDF渲染核心逻辑
        (async () => {
            try {
                const pdfDoc = await pdfjsLib.getDocument({
                    url: new URLSearchParams(location.search).get('file') || '/uploads/default.pdf',
                    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/cmaps/',
                    cMapPacked: true
                }).promise;

                document.getElementById('loading').remove();
                const container = document.getElementById('pdf-container');
                
                for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                    const page = await pdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1 });
                    const scale = (window.innerWidth - 40) / viewport.width;
                    const scaledViewport = page.getViewport({ scale });

                    const canvas = document.createElement('canvas');
                    canvas.className = 'page-canvas';
                    canvas.height = scaledViewport.height;
                    canvas.width = scaledViewport.width;
                    
                    await page.render({
                        canvasContext: canvas.getContext('2d'),
                        viewport: scaledViewport
                    }).prom
