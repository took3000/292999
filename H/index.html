<!DOCTYPE html>
<html>
<head>
    <title>解锁成功 - 氢写真</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
/* 微信提示层样式 */
.wechat-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  z-index: 9999;
  pointer-events: none;
  backdrop-filter: blur(28px);
  -webkit-backdrop-filter: blur(28px);
  background: rgba(255, 255, 255, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
}

.tip-card {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 12px;
  padding: 25px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  pointer-events: auto;
  max-width: 85%;
  text-align: center;
  transform: translateY(-10%);
}

.tip-text {
  font-size: 1.4rem;
  margin-bottom: 20px;
  color: #333;
  line-height: 1.5;
  font-weight: 500;
}

.copy-btn {
  background: #07c160;
  color: white;
  border: none;
  padding: 12px 35px;
  border-radius: 30px;
  font-size: 1.2rem;
  cursor: pointer;
  transition: all 0.3s ease;
  display: inline-block;
  box-shadow: 0 4px 12px rgba(7, 193, 96, 0.25);
}

.copy-btn:hover {
  background: #05a84d;
  transform: translateY(-2px);
}

.copy-btn.copied {
  background: #1890ff;
  padding: 12px 30px;
}

/* PDF内容模糊处理 */
.wechat-overlay + #pdf-container {
  filter: blur(8px);
  pointer-events: none;
  user-select: none;
}

.copy-btn {
  min-width: 120px; /* 防止文字变化时抖动 */
  position: relative;
  overflow: hidden;
}

.copy-btn::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255,255,255,0.2);
  opacity: 0;
  transition: opacity 0.3s;
}

.copy-btn:active::after {
  opacity: 1;
}
        
</style>
</head>
<body>
    <div id="loading">正在加载文档...</div>
    <div id="pdf-container"></div>

    <script>
        // 微信提示层初始化
        document.addEventListener('DOMContentLoaded', () => {
            if (/MicroMessenger/i.test(navigator.userAgent)) {
                const tip = document.createElement('div');
                tip.innerHTML = `
                    <div class="wechat-overlay">
                        <div class="tip-card">
                            <div class="tip-text">微信内看图体验受限，请复制链接到浏览器打开</div>
                            <button class="copy-btn" onclick="copyUrl(this)">点击复制链接</button>
                        </div>
                    </div>`;
                document.body.prepend(tip);
            }
        });

        // 修复后的PDF渲染逻辑
        (async () => {
            const loading = document.getElementById('loading');
            const container = document.getElementById('pdf-container');
            
            try {
                // 1. 确保获取有效的PDF地址
                const pdfUrl = new URLSearchParams(location.search).get('file') 
                             || '/uploads/default.pdf';
                
                // 2. 添加加载状态提示
                loading.textContent = '正在加载文档 (0%)...';

                // 3. 带进度提示的PDF加载
                const pdfDoc = await pdfjsLib.getDocument({
                    url: pdfUrl,
                    cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/cmaps/',
                    cMapPacked: true,
                    progressData: (progress) => {
                        // 更新加载进度
                        loading.textContent = `正在加载文档 (${Math.round(progress.loaded / progress.total * 100)}%)...`;
                    }
                }).promise;

                // 4. 加载完成后清除提示
                loading.remove();

                // 5. 逐页渲染
                for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                    const page = await pdfDoc.getPage(pageNum);
                    const viewport = page.getViewport({ scale: 1 });
                    const scale = (window.innerWidth - 40) / viewport.width;
                    const scaledViewport = page.getViewport({ scale });

                    // 创建画布元素
                    const canvas = document.createElement('canvas');
                    canvas.className = 'page-canvas';
                    canvas.height = scaledViewport.height;
                    canvas.width = scaledViewport.width;

                    // 渲染到画布
                    await page.render({
                        canvasContext: canvas.getContext('2d'),
                        viewport: scaledViewport
                    }).promise;

                    // 创建页面容器
                    const wrapper = document.createElement('div');
                    wrapper.className = 'page-wrapper';
                    wrapper.style.width = `${scaledViewport.width}px`;
                    wrapper.appendChild(canvas);
                    container.appendChild(wrapper);
                }

                // 6. 优化resize处理
                let resizeTimer;
                window.addEventListener('resize', () => {
                    clearTimeout(resizeTimer);
                    resizeTimer = setTimeout(() => {
                        container.innerHTML = '';
                        this(); // 重新执行渲染函数
                    }, 300);
                });

            } catch(err) {
                // 7. 增强错误处理
                console.error('PDF加载失败:', err);
                loading.innerHTML = `
                    <div style="color: red; text-align: center;">
                        <p>文档加载失败</p>
                        <p>错误信息: ${err.message}</p>
                        <p>请检查链接有效性或稍后重试</p>
                    </div>
                `;
            }
        })();

        function copyUrl(btn) {
  if(btn._isAnimating) return;
  btn._isAnimating = true;
  
  const originalText = btn.textContent;
  const originalWidth = btn.offsetWidth;
  
  // 锁定按钮尺寸
  btn.style.minWidth = `${originalWidth}px`;
  
  const success = () => {
    btn.textContent = '✓ 已复制';
    btn.classList.add('copied');
    
    // 添加波纹动画
    const ripple = document.createElement('div');
    ripple.style.cssText = `
      position: absolute;
      top: ${event.offsetY}px;
      left: ${event.offsetX}px;
      width: 0;
      height: 0;
      background: rgba(255,255,255,0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: ripple 0.6s ease-out;
    `;
    
    btn.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);

    // 3秒后恢复
    setTimeout(() => {
      btn.textContent = originalText;
      btn.classList.remove('copied');
      btn.style.minWidth = '';
      btn._isAnimating = false;
    }, 2000);
  };

  // 添加CSS动画
  const style = document.createElement('style');
  style.textContent = `
    @keyframes ripple {
      to {
        width: 200px;
        height: 200px;
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(style);
  
  // 原有复制逻辑...
}
    </script>
</body>
</html>
